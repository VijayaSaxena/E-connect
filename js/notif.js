var bg=chrome.extension.getBackgroundPage();var params={};var id;var accountId;var account;var closeTimer;var text="";var tweet;var timeOut=1000*localStorage.getItem("timeout");$(document).ready(function(){$("body").css("font-size",localStorage.getItem("fontSize")+"px");paramsIn=window.location.href.split("?");paramsIn=paramsIn[1].split("&")||null;for(var b in paramsIn){paramsIn[b]=paramsIn[b].split("=");params[paramsIn[b][0]]=unescape(paramsIn[b][1])}id=params.id;accountId=params.account;try{account=bg.twitter.getAccountById(accountId);tweet=jQuery.parseJSON(account.stream.response[id]);if(tweet.direct_message){if(tweet.direct_message.sender.id==account.id){$("#title").text("Message to "+tweet.direct_message.recipient.name);$("#reply").hide()}else{$("#title").text("Message from "+tweet.direct_message.sender.name);$("#reply").attr("href","javascript:reply("+id+")")}if(localStorage.getItem("stickyDm")=="true"&&tweet.direct_message.sender.id!=account.id){timeOut=0}$("#image").attr("src",tweet.direct_message.sender.profile_image_url);$("#title").attr("href","http://twitter.com/messages");$("#retweet, #favourite").hide();text=tweet.direct_message.text;tweet.entities={urls:[]}}else{var a=false;if(tweet.entities.user_mentions){for(var b in tweet.entities.user_mentions){if(tweet.entities.user_mentions[b].screen_name==account.screenName){a=true}}}if(a&&localStorage.getItem("stickyMention")=="true"){timeOut=0}if(tweet.retweeted_status){$("#rtBy").html('Retweeted by @<a href="http://twitter.com/'+tweet.user.screen_name+'">'+tweet.user.screen_name+"</a>");tweet=tweet.retweeted_status}if(tweet.user.id==account.id){$("#retweet, #reply").hide()}else{$("#reply").attr("href","reply://"+id)}$("#image").attr("src",tweet.user.profile_image_url);$("#title").text(tweet.user.name);$("#title").attr("href","http://twitter.com/"+tweet.user.screen_name);text=tweet.text}if(!tweet.entities.media){tweet.entities.media=[]}text=twttr.txt.autoLink(text,{urlEntities:tweet.entities.urls.concat(tweet.entities.media),hashtagClass:"hashtag",usernameClass:"at",usernameIncludeSymbol:true});$("#text").html(text);timer()}catch(c){window.close()}$(window).mouseover(function(){if(timeOut>0){clearTimeout(closeTimer)}});$(window).mouseout(function(){if(timeOut>0){closeTimer=setTimeout(function(){window.close()},2000)}});$("body").on("click","a",function(d){if(this.href.substr(0,4)=="http"){chrome.tabs.create({url:this.href});d.preventDefault()}else{if(this.href.substr(0,5)=="reply"){reply(this.href.split("://")[1])}}});$("#favourite").click(function(){bg.twitter.favourite(tweet.id_str,accountId);$("#favourite").css("background-image","url('images/favourited.png')");$("#favourite").unbind("click")});$("#retweet").click(function(){bg.twitter.retweet(tweet.id_str,accountId);$("#retweet").css("background-image","url('images/retweeted.png')");$("#retweet").unbind("click")});$("body").click(function(f){if(f.target.tagName!="A"&&f.target.parentNode.tagName!="A"){var d="http://twitter.com/"+tweet.user.screen_name+"/status/"+tweet.id_str;if(tweet.direct_message){d="http://twitter.com/messages/"}chrome.tabs.create({url:d})}})});window.onresize=function(){$("html, body").height($("#content").outerHeight())};function timer(){if(timeOut>0){closeTimer=setTimeout(function(){window.close()},timeOut)}}function reply(b){var e=bg.twttr.txt.extractMentions(text);var a=chrome.extension.getViews({});var d=[];e.unshift((tweet.user)?tweet.user.screen_name:tweet.direct_message.sender.screen_name);for(var c in a){if(a[c].updateTimeline){d.push(a[c])}}if(!d.length){chrome.windows.create({url:"timeline.html",width:360,height:600,type:"popup"},function(i){var h={};setTimeout(function(){while(!("onload" in h)){h=chrome.extension.getViews({windowId:i.id})[0]}g(h)},500)})}else{var f=d[0];f.focus();g(f)}function g(k){var h=k.document.getElementById("account-select-input");for(var j=0;j<h.children.length;j++){if(h.children[j].value==accountId){break}}h.selectedIndex=j;h.onchange();if(tweet.direct_message){k.replyToDM(tweet.direct_message.sender.id_str)}else{k.replyTo(tweet.id_str,e)}}}window.onerror=function(d,a,f){bg.console.log("Error: "+d+","+a+","+f);window.close()};